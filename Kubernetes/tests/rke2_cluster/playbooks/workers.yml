# Getting credential from Rancher node
- name: "Get credentials"
  hosts: k3s_cluster
  vars_files:
    - "../../global_vars.yml"
  become: true

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:

  - name: "Get API token"
    ansible.builtin.uri:
      body:
        description: "UI session"
        responseType: "cookie"
        username: admin
        password: oscar
      body_format: "json"
      method: POST
      url: https://{{ rancher_hostname }}/v3-public/localProviders/local?action=login
      validate_certs: false
    until: rancher_cookie.status == 200
    retries: 30
    delay: 10
    register: rancher_cookie

  - name: "Get cluster ID"
    ansible.builtin.uri:
      url: "https://{{ rancher_hostname }}/v3/clusters"
      validate_certs: false
      method: GET
      headers:
        Cookie: "{{ rancher_cookie.cookies_string }}"
    register: "rancher_cluster_data"

  - name: Extract Cluster ID from Cluster Data
    set_fact:
      cluster_id: "{{ rancher_cluster_data.json.data | selectattr('name', 'equalto', 'project') | map(attribute='id') | first }}"

  - debug: msg="{{ cluster_id }}"
  
  - name: "Get registration command"
    ansible.builtin.uri:
      url: "https://{{ rancher_hostname }}/v3/clusterregistrationtokens"
      method: GET
      headers:
        Cookie: "{{ rancher_cookie.cookies_string }}"
      validate_certs: false
    register: "rancher_response_register"

  - debug: msg="{{ rancher_response_register.json }}"

  - name: Extract Cluster ID 
    set_fact:
      token: "{{ rancher_response_register.json.data | selectattr('clusterId', 'equalto', cluster_id ) | map(attribute='token') | first }}"

  - debug: msg="{{ token }}"
  
  - name: Get Rancher CA certificate from Secret
    kubernetes.core.k8s_info:
      kind: Secret
      name: tls-rancher-ingress
      namespace: cattle-system
    register: rancher_secret

  - name: Save CA certificate to /tmp/ca.crt
    ansible.builtin.copy:
      # We access the 'ca.crt' key inside the 'data' dictionary of the first resource found
      content: "{{ rancher_secret.resources[0].data['ca.crt'] | b64decode }}"
      dest: /tmp/ca.crt
      mode: '0644'

  - name: "Get CheckSum token"
    ansible.builtin.stat:
      checksum_algorithm: sha256
      get_checksum: true
      path: /tmp/ca.crt
    register: ca_checksum

  - debug: msg="{{ ca_checksum.stat.checksum }}"

# Another task: working on the nodes
- name: "Register workers nodes"
  hosts: worker
  vars_files:
    - "../../global_vars.yml"
    - "../group_vars/worker.yml"
    
  tasks:
  - name: Create RKE2 config directory
    ansible.builtin.file:
      path: /etc/rancher/rke2
      state: directory
      mode: '0755'

  - name: Check current resolv.conf status
    ansible.builtin.command: grep -q "127.0.0.53" /etc/resolv.conf
    register: dns_check
    failed_when: false
    changed_when: false
    
  - name: Write RKE2 configuration file
    ansible.builtin.copy:
      dest: /etc/rancher/rke2/config.yaml
      content: |
        services:
          kubelet:
            extra_args:
              resolv-conf: "/run/systemd/resolve/resolv.conf"
      owner: root
      group: root
      mode: '0644'
    when: dns_check.rc == 0

  - name: "Downloading agent"
    ansible.builtin.get_url:
      dest: "/tmp/rancher.sh"
      url: "https://{{ rancher_hostname }}/system-agent-install.sh"
      mode: '0755'
      force: true
      validate_certs: false

- name: "Register first worker node"
  hosts: worker1
  vars_files:
    - "../../global_vars.yml"
    - "../group_vars/worker.yml"
    
  tasks:
  - name: "Execute script to register the node"
    ansible.builtin.shell:
      executable: "/usr/bin/bash"
      cmd: "/tmp/rancher.sh --server https://{{ rancher_hostname }} --label 'cattle.io/os=linux' --token {{ hostvars[groups['k3s_cluster'][0]]['rancher_response_register']['json']['data'][0]['token'] }} --ca-checksum {{ hostvars[groups['k3s_cluster'][0]]['ca_checksum']['stat']['checksum'] }} --worker {{ rancher_worker_node_1_name }}"

- name: "Register second worker node"
  hosts: worker2
  vars_files:
    - "../../global_vars.yml"
    - "../group_vars/worker.yml"
    - "../../k3s_cluster/group_vars/rancher.yml"

  tasks:
  - name: "Execute script to register the node"
    ansible.builtin.shell:
      executable: "/usr/bin/bash"
      cmd: "/tmp/rancher.sh --server https://{{ rancher_hostname }} --label 'cattle.io/os=linux' --token {{ hostvars[groups['k3s_cluster'][0]]['rancher_response_register']['json']['data'][0]['token'] }} --ca-checksum {{ hostvars[groups['k3s_cluster'][0]]['ca_checksum']['stat']['checksum'] }} --worker {{ rancher_worker_node_1_name }}"