- name: "Create Rancher workload"
  hosts: k3s_cluster
  vars_files:
    - "../group_vars/rancher.yml"
  become: true
  
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  
  tasks:
  # Create namespace cattle-system
  - name: Create a k8s namespace
    kubernetes.core.k8s:
      name: cattle-system
      api_version: v1
      kind: Namespace
      state: present

  # Download and apply cert-manager credits
  - name: Download cert-manager credits
    ansible.builtin.get_url:
      url: https://github.com/cert-manager/cert-manager/releases/download/v1.19.2/cert-manager.crds.yaml
      dest: /tmp/crds.yml
      mode: '0664'

  - name: Apply cert-manager credits yaml
    kubernetes.core.k8s:
      state: present
      src: /tmp/crds.yml
      name: cattle-system

  # Add repo forthe rancher and jetstack
  - name: Add stable chart repo for rancher
    kubernetes.core.helm_repository:
      name: rancher-latest
      repo_url: "https://releases.rancher.com/server-charts/latest"
  
  - name: Add stable chart repo for Jetstack
    kubernetes.core.helm_repository:
      name: jetstack
      repo_url: "https://charts.jetstack.io"
  
  # Deploy jetstack
  - name: Deploy latest version of cert-manager chart
    kubernetes.core.helm:
      name: cert-manager
      chart_ref: jetstack/cert-manager
      release_namespace: cert-manager
      create_namespace: true

  # Deploy rancher
  - name: Deploy latest version of Rancher chart
    kubernetes.core.helm:
      name: rancher
      chart_ref: rancher-latest/rancher
      release_namespace: cattle-system
      values:
        replicas: 1
        hostname: "{{ rancher_hostname }}"
        bootstrapPassword: "oscar"

  # Download Rancher CLI binary
  - name: "Download Rancher Command Line Interface"
    ansible.builtin.unarchive:
      src: "https://github.com/rancher/cli/releases/download/v2.13.2/rancher-linux-amd64-v2.13.2.tar.gz"
      dest: /tmp/
      remote_src: yes

  # Add the binary to the path
  - name: "Moove the binary to bin"
    ansible.builtin.copy:
      src: "/tmp/rancher-v2.13.2/rancher"
      dest: /usr/local/bin/rancher
      mode: 0755
      remote_src: yes

  # Requesting the API
  - name: "Get API token"
    ansible.builtin.uri:
      body:
        description: "UI session"
        responseType: "cookie"
        username: admin
        password: oscar
      body_format: "json"
      method: POST
      url: https://{{ rancher_hostname }}/v3-public/localProviders/local?action=login
      validate_certs: false

    register: rancher_cookie
  
  # Printing cookie response
  - debug: msg="{{ rancher_cookie.cookies['R_SESS'] }}"

  # Create API Bearer Token
  - name: "Create API Bearer Token"
    ansible.builtin.uri:
      url: https://{{ rancher_hostname }}/v3/tokens
      body_format: "json"
      method: POST
      validate_certs: false
      headers:
        Cookie: "{{ rancher_cookie.cookies_string }}"
      body:
        type: "token"
        metadata: "{}"
        description: nouveau
        tti: 7776000000
      status_code: [201]
    register: "rancher_api_token"


  - name: "Create cluster"
    ansible.builtin.uri:
      url: "https://{{ rancher_hostname }}/v1/provisioning.cattle.io.clusters"
      body_format: json
      headers:
        Cookie: "{{ rancher_cookie.cookies_string }}"
      body: "{{ rancher_cluster_json_body }}"
      method: POST
      validate_certs: false
      status_code: [201]
    ignore_errors: True
  
  - name: "Get registration command"
    ansible.builtin.uri:
      url: "https://{{ rancher_hostname }}/v3/clusterregistrationtokens"
      method: GET
      headers:
        Cookie: "{{ rancher_cookie.cookies_string }}"
      validate_certs: false
    register: "rancher_response_register"
  
  - debug: msg="{{ rancher_response_register }}"
  
  - name: Get Rancher CA certificate from Secret
    kubernetes.core.k8s_info:
      kind: Secret
      name: tls-rancher-ingress
      namespace: cattle-system
    register: rancher_secret

  - name: Save CA certificate to /tmp/ca.crt
    ansible.builtin.copy:
      # We access the 'ca.crt' key inside the 'data' dictionary of the first resource found
      content: "{{ rancher_secret.resources[0].data['ca.crt'] | b64decode }}"
      dest: /tmp/ca.crt
      mode: '0644'

  - name: "Get CheckSum token"
    ansible.builtin.stat:
      checksum_algorithm: sha256
      get_checksum: true
      path: /tmp/ca.crt
    register: ca_checksum

  - debug: msg="{{ ca_checksum.stat.checksum }}"