- name: "Create Kubectl workload"
  hosts: k3s_cluster
  vars_files:
    - "../group_vars/kubectl.yml"
  
  environment:
    INSTALL_K3S_VERSION: "{{ k3s_version }}"
  
  tasks:
  - name: "Update packages"
    ansible.builtin.apt:
      name: "curl gpg apt-transport-https"
      state: present
  
  - name: "Check if Rancher is already installed"
    ansible.builtin.stat:
        path: "/tmp/get_helm.sh"
    register: "rancher_exe"

  - name: "Download script from k3s"
    when: "not rancher_exe.stat.exists"
    ansible.builtin.get_url:
      dest: "/tmp/get_helm.sh"
      url: "https://dl.k8s.io/release/v1.35.0/bin/linux/amd64/kubectl"
      mode: '0700'

  - name: "Execute script"
    ansible.builtin.shell:
      executable: "/usr/bin/bash"
      cmd: "/tmp/get_helm.sh"

  - name: "Wait for node token to be generated"
    ansible.builtin.wait_for:
      path: /var/lib/rancher/k3s/server/node-token
  become: true